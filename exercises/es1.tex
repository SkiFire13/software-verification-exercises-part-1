\begin{exercise}{
    Prove that if $\left<\texttt{repeat}\ S\ \texttt{until}\ b, s\right> \Rightarrow^* s'$ then $\Bool{b} s' = \text{tt}$
}
    By induction on the lenght $k$ of the derivation $\left<\texttt{repeat } S \texttt{ until } b\right> \Rightarrow^k s'$:
    \begin{itemize}
        \item base case $k=0$: we want to prove:
            \[ \left<\texttt{repeat}\ S\ \texttt{until}\ b,s\right> \Rightarrow^0 s' \implies \Bool{b} s' = \text{tt} \]
            The premise is trivially false, so the whole implication is true;
        \item inductive case $k+1$: we want to prove:
            \[ \left<\texttt{repeat}\ S\ \texttt{until}\ b, s\right> \Rightarrow^{k+1} s' \implies \Bool{b} s' = \text{tt} \]
            First, we execute a step of the derivation:
            \begin{align*}
                &\left<\texttt{repeat}\ S\ \texttt{until}\ b, s\right>
                \\&\qquad \Rightarrow \left<S; \texttt{if}\ b\ \texttt{then}\ skip\ \texttt{else}\ (\texttt{repeat}\ S\ \texttt{until}\ b), s\right>
                \\&\qquad \Rightarrow^k s'
            \end{align*}
            By the decomposition lemma $\exists k_1, k_2 :$
            \begin{gather*}
                k_1 + k_2 = k \\
                \left<S, s\right> \Rightarrow^{k_1} s'' \\
                \left<\texttt{if}\ b\ \texttt{then}\ skip\ \texttt{else}\ (\texttt{repeat}\ S\ \texttt{until}\ b), s''\right> \Rightarrow^{k_2} s'
            \end{gather*}
            We then distinguish two cases:
            \begin{itemize}
                \item $\Bool{b} s'' = \text{tt}$:
                    \begin{align*}
                        &\left<\texttt{if}\ b\ \texttt{then}\ skip\ \texttt{else}\ (\texttt{repeat}\ S\ \texttt{until}\ b), s''\right>
                        \\&\qquad \Rightarrow \left<skip, s''\right>
                        \\&\qquad \Rightarrow s'' = s'
                    \end{align*}
                    Thus $\Bool{ b} s'' = \Bool{ b} s' = \text{tt}$
                \item $\Bool{ b} s'' = \text{ff}$
                    \begin{align*}
                        &\left<\texttt{if}\ b\ \texttt{then}\ skip\ \texttt{else}\ (\texttt{repeat}\ S\ \texttt{until}\ b), s''\right>
                        \\&\qquad \Rightarrow \left<\texttt{repeat}\ S\ \texttt{until}\ b, s\right>
                        \\&\qquad \Rightarrow^{k_2 - 1} s'
                    \end{align*}
                    Since $k_2 - 1 = k - k_1 - 1 \leq k$, by inductive hypothesis we have $\Bool{ b} s' = \text{tt}$
            \end{itemize}
    \end{itemize}
\end{exercise}
