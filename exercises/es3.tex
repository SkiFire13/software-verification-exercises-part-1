\begin{exercise}{
    Prove or disprove the following semantic equivalence:
    \[ \texttt{while}\ b\ \texttt{do}\ S \cong_{\text{\tiny SOS}} \texttt{while}\ b\ \texttt{do}\ (\wrepeat{S}{\neg b})  \]\vspace*{-0.6cm}
}
    We want to prove $\forall S \in \texttt{While}, b \in \texttt{Bexp}, s, s' \in \texttt{State}$
    \[ \instr{\texttt{while}\ b\ \texttt{do}\ S}{s} \Rightarrow^* s' \]\vspace*{-0.9cm}
    \[ \iff \]\vspace*{-0.7cm}
    \[ \instr{\texttt{while}\ b\ \texttt{do}\ (\wrepeat{S}{\neg b})}{s} \Rightarrow^* s' \]
    We do this by proving:
    \begin{gather*}
        \instr{\texttt{while}\ b\ \texttt{do}\ S}{s} \Rightarrow^* s' \\
        \iff \\
        \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ \wrepeat{S}{\neg b}}{s} \Rightarrow^* s' \\
        \iff \\
        \instr{\texttt{while}\ b\ \texttt{do}\ (\wrepeat{S}{\neg b})}{s} \Rightarrow^* s'
    \end{gather*}
    Let $S_r = \wrepeat{S}{\neg b}$ for brevity.
    \begin{itemize}
        \item $\instr{\texttt{while}\ b\ \texttt{do}\ S}{s} \Rightarrow^* s' \implies \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s} \Rightarrow^* s'$ \\
            By induction on the length $k$ of $\instr{\texttt{while}\ b\ \texttt{do}\ S}{s} \Rightarrow^k s'$
            \begin{itemize}
                \item base case $k=0$ \\
                $\instr{\texttt{while}\ b\ \texttt{do}\ S}{s} \Rightarrow^0 s'$ is false, so the implication is trivially true.
                \item inductive case $k+1$ \vspace*{-0.3cm}
                \begin{align*}
                    &\instr{\texttt{while}\ b\ \texttt{do}\ S}{s}
                    \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S; \texttt{while}\ b\ \texttt{do}\ S)\ \texttt{else}\ skip}{s}
                    \\&\qquad\Rightarrow^k s'
                \end{align*}
                We then distinguish two cases:
                \begin{itemize}
                    \item $\Bool{ b} s = \text{ff}$
                    \begin{gather*}
                        \instr{\texttt{if}\ b\ \texttt{then} (S; \texttt{while}\ b\ \texttt{do}\ S)\ \texttt{else}\ skip}{s}
                        \Rightarrow
                        \instr{skip}{s}
                        \Rightarrow s
                        \\
                        \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                        \Rightarrow
                        \instr{skip}{s}
                        \Rightarrow s
                    \end{gather*}
                    \item $\Bool{ b} s = \text{tt}$
                        \begin{align*}
                            &\instr{\texttt{if}\ b\ \texttt{then} (S; \texttt{while}\ b\ \texttt{do}\ S)\ \texttt{else}\ skip}{s}
                            \\&\qquad\Rightarrow \instr{S; \texttt{while}\ b\ \texttt{do}\ S}{s}
                            \\&\qquad\Rightarrow^{k-1} s'
                        \end{align*}
                        By the decomposition lemma $\exists k_1, k_2 :$
                        \begin{gather*}
                            k_1 + k_2 = k - 2 \\
                            \instr{S}{s} \Rightarrow^{k_1} s'' \\
                            \instr{\texttt{while}\ b\ \texttt{do}\ S}{s''} \Rightarrow^{k_2} s'
                        \end{gather*}
                        Then
                        \begin{align*}
                            &\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                            \\&\quad\Rightarrow \instr{S_r}{s}
                            \\&\quad\Rightarrow \instr{S; \texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                            \\&\text{(By the composition lemma)}
                            \\&\quad\Rightarrow^* \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s''}
                        \end{align*}
                        And since $\instr{\texttt{while}\ b\ \texttt{do}\ S}{s''} \Rightarrow^{k_2} s'$ and $k_2 = k - 2 - k_1 \leq k$  we can apply the inductive hypothesis and get
                        \[ \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s''} \Rightarrow s' \]
                \end{itemize}
            \end{itemize}
        \item $\instr{\texttt{while}\ b\ \texttt{do}\ S}{s} \Rightarrow^* s' \impliedby \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s} \Rightarrow^* s'$ \\
            By induction on the length $k$ of $\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s} \Rightarrow^k s'$
            \begin{itemize}
                \item base case $k=0$ \\
                $\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s} \Rightarrow^0 s'$ is false, so the implication is trivially true.
                \item inductive case $k+1$ \vspace*{-0.3cm}
                \[ \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s} \Rightarrow^{k+1} s' \]
                We then distinguish two cases:
                \begin{itemize}
                    \item $\Bool{ b} s = \text{ff}$
                    \begin{gather*}
                        \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                        \Rightarrow
                        \instr{skip}{s}
                        \Rightarrow s
                        \\
                        \begin{align*}
                            &\instr{\texttt{while}\ b\ \texttt{do}\ S}{s}
                            \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S; \texttt{while}\ b\ \texttt{do}\ S)\ \texttt{else}\ skip}{s}
                            \\&\qquad\Rightarrow \instr{skip}{s}
                            \\&\qquad\Rightarrow s
                        \end{align*}
                    \end{gather*}
                    \item $\Bool{ b} s = \text{tt}$
                    \begin{align*}
                        &\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                        \\&\qquad\Rightarrow \instr{S_r}{s}
                        \\&\qquad\Rightarrow \instr{S; \texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                        \\&\qquad\Rightarrow^k s'
                    \end{align*}
                    By the decomposition lemma $\exists k_1, k_2 :$
                    \begin{gather*}
                        k_1 + k_2 = k - 1 \\
                        \instr{S}{s} \Rightarrow^{k_1} s'' \\
                        \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s''} \Rightarrow^{k_2} s'
                    \end{gather*}
                    Then
                    \begin{align*}
                        &\instr{\texttt{while}\ b\ \texttt{do}\ S}{s}
                        \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S; \texttt{while}\ b\ \texttt{do}\ S)\ \texttt{else}\ skip}{s}
                        \\&\qquad\Rightarrow \instr{S; \texttt{while}\ b\ \texttt{do}\ S}{s}
                        \\&\text{By the composition lemma}
                        \\&\qquad\Rightarrow \instr{\texttt{while}\ b\ \texttt{do}\ S}{s''}
                    \end{align*}
                    And since $\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s''} \Rightarrow^{k_2} s'$ and $k_2 = k - 1 - k_1 \leq k$  we can apply the inductive hypothesis and get
                    \[ \instr{\texttt{while}\ b\ \texttt{do}\ S}{s''} \Rightarrow s' \]
                \end{itemize}
            \end{itemize}
        \item $\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s} \Rightarrow^* s' \implies \instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s} \Rightarrow^* s$ \\
            We distinguish two cases:
            \begin{itemize}
                \item $\Bool{ b} s = \text{ff}$
                \begin{gather*}
                    \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                    \Rightarrow
                    \instr{skip}{s}
                    \Rightarrow s
                    \\
                    \begin{align*}
                        &\instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s}
                        \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S_r; \texttt{while}\ b\ \texttt{do}\ S_r)\ \texttt{else}\ skip}{s}
                        \\&\qquad\Rightarrow \instr{skip}{s}
                        \\&\qquad\Rightarrow s
                    \end{align*}
                \end{gather*}
                \item $\Bool{ b} s = \text{tt}$
                \[
                    \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                    \Rightarrow
                    \instr{S_r}{s}
                    \Rightarrow^* s'
                \]
                By the termination lemma $\Bool{ \neg b} s' = tt$ \\
                $\implies \Bool{ b} s' = ff$
                \begin{align*}
                    &\instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s}
                    \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S_r; \texttt{while}\ b\ \texttt{do}\ S_r)\ \texttt{else}\ skip}{s}
                    \\&\qquad\Rightarrow \instr{S_r; \texttt{while}\ b\ \texttt{do}\ S_r}{s}
                    \\&\text{(By composition lemma)}
                    \\&\qquad\Rightarrow^* \instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s'}
                    \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S_r; \texttt{while}\ b\ \texttt{do}\ S_r)\ \texttt{else}\ skip}{s'}
                    \\&\qquad\Rightarrow \instr{skip}{s'}
                    \\&\qquad\Rightarrow s'
                \end{align*}
            \end{itemize}
        \item $\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s} \Rightarrow^* s' \impliedby \instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s} \Rightarrow^* s$ \\
            We distinguish two cases:\begin{itemize}
                \item $\Bool{ b} s = \text{ff}$
                \begin{gather*}
                    \begin{align*}
                        &\instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s}
                        \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S_r; \texttt{while}\ b\ \texttt{do}\ S_r)\ \texttt{else}\ skip}{s}
                        \\&\qquad\Rightarrow \instr{skip}{s}
                        \\&\qquad\Rightarrow s
                    \end{align*}
                    \\
                    \instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                    \Rightarrow
                    \instr{skip}{s}
                    \Rightarrow s
                \end{gather*}
                \item $\Bool{ b} s = \text{tt}$
                \begin{align*}
                    &\instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s}
                    \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S_r; \texttt{while}\ b\ \texttt{do}\ S_r)\ \texttt{else}\ skip}{s}
                    \\&\qquad\Rightarrow \instr{S_r; \texttt{while}\ b\ \texttt{do}\ S_r}{s}
                \end{align*}
                By the decomposition lemma:
                \[ \instr{S_r}{s} \Rightarrow^* s'' \qquad \instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s''} \Rightarrow^* s' \]
                By the termination lemma $\Bool{ \neg b} s'' = \texttt{tt}$ \\
                $\implies \Bool{ b} s'' = \texttt{ff}$ \\
                Thus
                \begin{align*}
                    &\instr{\texttt{while}\ b\ \texttt{do}\ S_r}{s''}
                    \\&\qquad\Rightarrow \instr{\texttt{if}\ b\ \texttt{then} (S_r; \texttt{while}\ b\ \texttt{do}\ S_r)\ \texttt{else}\ skip}{s''}
                    \\&\qquad\Rightarrow \instr{skip}{s''}
                    \\&\qquad\Rightarrow s'' = s'
                \end{align*}
                And finally
                \begin{align*}
                    &\instr{\texttt{if}\ \neg b\ \texttt{then}\ skip\ \texttt{else}\ S_r}{s}
                    \\&\qquad\Rightarrow \instr{S_r}{s}
                    \\&\qquad\Rightarrow^* s'' = s'
                \end{align*}
            \end{itemize}
    \end{itemize}
\end{exercise}
